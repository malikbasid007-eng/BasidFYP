{% extends "base.html" %}

{% block title %}{{ session.session_name }} - Attendance Details{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Session Header -->
        <div class="card mb-4 border-success">
            <div class="card-header bg-success text-white">
                <div class="row align-items-center">
                    <div class="col">
                        <h4 class="mb-0">
                            <i class="fas fa-clipboard-check me-2"></i>
                            {{ session.session_name }}
                        </h4>
                        <small>{{ session.class_name }} - {{ session.date.strftime('%B %d, %Y') }} at {{ session.time.strftime('%I:%M %p') }}</small>
                    </div>
                    <div class="col-auto">
                        <a href="{{ url_for('attendance') }}" class="btn btn-light">
                            <i class="fas fa-arrow-left me-2"></i>Back to Sessions
                        </a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="stat-number text-primary">{{ session.total_students }}</div>
                            <small class="text-muted">Total Students</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="stat-number text-success">{{ session.present_students }}</div>
                            <small class="text-muted">Present</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="stat-number text-danger">{{ session.total_students - session.present_students }}</div>
                            <small class="text-muted">Absent</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            {% set percentage = (session.present_students / session.total_students * 100) if session.total_students > 0 else 0 %}
                            <div class="stat-number text-info">{{ "%.1f"|format(percentage) }}%</div>
                            <small class="text-muted">Attendance Rate</small>
                        </div>
                    </div>
                </div>
                
                <!-- Progress Bar -->
                <div class="mt-3">
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar bg-success" style="width: {{ percentage|round(1) }}%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Attendance Records -->
        <div class="card shadow-sm">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-users me-2"></i>
                    Student Attendance Records
                </h5>
            </div>
            <div class="card-body">
                {% if records %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Photo</th>
                                <th>Student ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Status</th>
                                <th>Confidence</th>
                                <th>Time Detected</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for record, student in records %}
                            <tr class="{{ 'table-success' if record.is_present else 'table-danger' }}">
                                <td>
                                    {% if student.image_path %}
                                    <img src="{{ url_for('serve_student_image', filename=student.image_path.split('/')[-1]) }}" 
                                         alt="{{ student.name }}" 
                                         class="rounded-circle" width="40" height="40" 
                                         style="object-fit: cover;"
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                    <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center" 
                                         style="width: 40px; height: 40px; display: none;">
                                        <i class="fas fa-user text-white"></i>
                                    </div>
                                    {% else %}
                                    <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center" 
                                         style="width: 40px; height: 40px;">
                                        <i class="fas fa-user text-white"></i>
                                    </div>
                                    {% endif %}
                                </td>
                                <td><strong>{{ student.student_id }}</strong></td>
                                <td>{{ student.name }}</td>
                                <td>{{ student.email }}</td>
                                <td>
                                    {% if record.is_present %}
                                    <span class="badge bg-success">
                                        <i class="fas fa-check me-1"></i>Present
                                    </span>
                                    {% else %}
                                    <span class="badge bg-danger">
                                        <i class="fas fa-times me-1"></i>Absent
                                    </span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if record.confidence_score > 0 %}
                                    <div class="d-flex align-items-center">
                                        <span class="me-2">{{ "%.1f"|format(record.confidence_score * 100) }}%</span>
                                        <div class="progress confidence-progress">
                                            <div class="progress-bar {{ 'bg-success' if record.confidence_score > 0.7 else 'bg-warning' if record.confidence_score > 0.5 else 'bg-danger' }}" 
                                                 data-width="{{ (record.confidence_score * 100)|round(1) }}"></div>
                                        </div>
                                    </div>
                                    {% else %}
                                    <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if record.detected_at %}
                                    {{ record.detected_at.strftime('%H:%M:%S') }}
                                    {% else %}
                                    <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                    <h5 class="text-muted">No Attendance Records</h5>
                    <p class="text-muted">No attendance records found for this session.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Group Photo (if available) -->
        {% if session.group_photo_path %}
        <div class="card mt-4 shadow-sm">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-camera me-2"></i>
                    Group Photo
                </h5>
            </div>
            <div class="card-body text-center">
                <img src="{{ url_for('serve_upload', filename=session.group_photo_path.split('/')[-1]) }}" 
                     alt="Group Photo" 
                     class="img-fluid rounded" style="max-height: 400px;"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <div style="display: none;" class="text-muted">
                    <i class="fas fa-image fa-3x mb-3"></i>
                    <p>Group photo not available</p>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Action Buttons -->
        <div class="row mt-4">
            <div class="col-12 text-center">
                <a href="{{ url_for('attendance') }}" class="btn btn-secondary me-2">
                    <i class="fas fa-list me-2"></i>All Sessions
                </a>
                <a href="{{ url_for('take_attendance') }}" class="btn btn-success me-2">
                    <i class="fas fa-camera me-2"></i>Take New Attendance
                </a>
                <button class="btn btn-info" onclick="window.print()">
                    <i class="fas fa-print me-2"></i>Print Report
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
    .stat-number {
        font-size: 2rem;
        font-weight: bold;
        line-height: 1;
    }
    
    .confidence-progress {
        width: 60px;
        height: 6px;
    }
    
    @media print {
        .btn, .card-header .btn {
            display: none !important;
        }
        
        .card {
            border: 1px solid #dee2e6 !important;
            box-shadow: none !important;
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    // Set progress bar widths from data attributes
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.progress-bar[data-width]').forEach(function(bar) {
            bar.style.width = bar.getAttribute('data-width') + '%';
        });
    });
</script>
{% endblock %}
